#!/bin/bash

prefix=$1

# source common functions
if [ -e /usr/lib/xen-tools/common.sh ]; then
    . /usr/lib/xen-tools/common.sh
else
    echo "Installation problem in $0"
fi

logMessage Script $0 starting
logMessage "${0}: Overwriting /etc/apt/sources.list with StuSta mirrors"


cat > ${prefix}/etc/apt/sources.list <<EOF
# StuSta mirrors
#
# Generated by 10-apt-sources

deb http://mirror.stusta.mhn.de/debian-security/ wheezy/updates main contrib non-free
deb-src http://mirror.stusta.mhn.de/debian-security/ wheezy/updates main contrib non-free

deb http://mirror.stusta.mhn.de/debian/ wheezy main contrib non-free
deb-src http://mirror.stusta.mhn.de/debian/ wheezy main contrib non-free

deb http://mirror.stusta.mhn.de/debian/ wheezy-updates main contrib non-free
deb-src http://mirror.stusta.mhn.de/debian/ wheezy-updates main contrib non-free


deb http://security.debian.org/ wheezy/updates main contrib non-free
deb-src http://security.debian.org/ wheezy/updates main contrib non-free

deb http://http.debian.net/debian/ wheezy main contrib non-free
deb-src http://http.debian.net/debian/ wheezy main contrib non-free

deb http://http.debian.net/debian/ wheezy-updates main contrib non-free
deb-src http://http.debian.net/debian/ wheezy-updates main contrib non-free
EOF

logMessage "${0}: Configuring apt proxy"
cat > ${prefix}/etc/apt/apt.conf.d/30proxy <<EOF
Acquire
{
  http {
    Proxy "http://proxy.stusta.mhn.de:3128/";
    Proxy::mirror.stusta.mhn.de "DIRECT";
  }
}
EOF

logMessage "${0}: Disabling auto install recommends"
cat > ${prefix}/etc/apt/apt.conf.d/20recommends <<EOF
APT::Install-Recommends "false";
EOF

chroot ${prefix} aptitude update

logMessage "$0 finished setting mirrors "
