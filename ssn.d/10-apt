#!/bin/bash

prefix=$1

# source common functions
if [ -e /usr/share/xen-tools/common.sh ]; then
    . /usr/share/xen-tools/common.sh
else
    echo "Installation problem in $0"
fi

logMessage Script $0 starting
logMessage "${0}: Overwriting /etc/apt/sources.list with StuSta mirrors"


cat > ${prefix}/etc/apt/sources.list <<EOF
# StuSta mirrors
#
# Generated by 10-apt-sources

deb http://mirror.stusta.mhn.de/debian-security/ jessie/updates main contrib non-free
deb-src http://mirror.stusta.mhn.de/debian-security/ jessie/updates main contrib non-free

deb http://mirror.stusta.mhn.de/debian/ jessie main contrib non-free
deb-src http://mirror.stusta.mhn.de/debian/ jessie main contrib non-free

deb http://mirror.stusta.mhn.de/debian/ jessie-updates main contrib non-free
deb-src http://mirror.stusta.mhn.de/debian/ jessie-updates main contrib non-free


deb http://security.debian.org/ jessie/updates main contrib non-free
deb-src http://security.debian.org/ jessie/updates main contrib non-free

deb http://ftp.de.debian.org/debian/ jessie main contrib non-free
deb-src http://ftp.de.debian.org/debian/ jessie main contrib non-free

deb http://ftp.de.debian.org/debian/ jessie-updates main contrib non-free
deb-src http://ftp.de.debian.org/debian/ jessie-updates main contrib non-free
EOF

logMessage "${0}: Configuring apt proxy"
cat > ${prefix}/etc/apt/apt.conf.d/30proxy <<EOF
Acquire
{
  http {
    Proxy "http://proxy.stusta.mhn.de:3128/";
    Proxy::mirror.stusta.mhn.de "DIRECT";
  }
}
EOF

logMessage "${0}: Disabling auto install recommends"
cat > ${prefix}/etc/apt/apt.conf.d/20recommends <<EOF
APT::Install-Recommends "false";
EOF

chroot ${prefix} apt-get update

logMessage "$0 finished setting mirrors "
